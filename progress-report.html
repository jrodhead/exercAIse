<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Progress Report - exercAIse</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <div id="header-placeholder"></div>

    <div class="progress-report">
        <div class="progress-report__header">
            <h1>ðŸ“Š Training Progress Report</h1>
            <p>Comprehensive analysis of your training performance and progression</p>
            <div class="progress-report__meta">
                <div class="progress-report__meta-item">
                    <span class="progress-report__meta-label">Report Period</span>
                    <span class="progress-report__meta-value" id="report-period">Loading...</span>
                </div>
                <div class="progress-report__meta-item">
                    <span class="progress-report__meta-label">Total Sessions</span>
                    <span class="progress-report__meta-value" id="total-sessions">-</span>
                </div>
                <div class="progress-report__meta-item">
                    <span class="progress-report__meta-label">Blocks Completed</span>
                    <span class="progress-report__meta-value" id="blocks-completed">-</span>
                </div>
                <div class="progress-report__meta-item">
                    <span class="progress-report__meta-label">Generated</span>
                    <span class="progress-report__meta-value" id="report-date">-</span>
                </div>
            </div>
        </div>

        <div class="progress-report__controls">
            <h3>View Saved Reports</h3>
            <label for="report-selector">Select Report</label>
            <select id="report-selector">
                <option value="">Loading reports...</option>
            </select>
            
            <h3 style="margin-top: var(--space-6, 24px);">Generate New Report</h3>
            <label for="time-range">Time Range</label>
            <select id="time-range">
                <option value="all">All Time</option>
                <option value="last-4-weeks">Last 4 Weeks</option>
                <option value="last-8-weeks">Last 8 Weeks</option>
                <option value="block-4">Block 4</option>
                <option value="block-3">Block 3</option>
                <option value="block-2">Block 2</option>
                <option value="custom">Custom Date Range</option>
            </select>

            <div id="custom-dates" style="display: none;">
                <label for="start-date">Start Date</label>
                <input type="date" id="start-date">
                <label for="end-date">End Date</label>
                <input type="date" id="end-date">
            </div>

            <button id="generate-report">Generate Report</button>
        </div>

        <div id="report-content" class="report-container">
            <div class="progress-report__loading">Loading your training data...</div>
        </div>
    </div>

    <script src="assets/header-loader.js"></script>
    <script src="dist/assets/progress-report-renderer.js"></script>
    <script>
        // Initialize on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // Load available reports and populate selector
            loadReportSelector();
            
            // Handle report selection changes
            document.getElementById('report-selector').addEventListener('change', async (e) => {
                const reportPath = e.target.value;
                if (reportPath) {
                    await loadSelectedReport(reportPath);
                }
            });
            
            // Handle time range changes
            document.getElementById('time-range').addEventListener('change', (e) => {
                const customDates = document.getElementById('custom-dates');
                if (e.target.value === 'custom') {
                    customDates.style.display = 'block';
                } else {
                    customDates.style.display = 'none';
                }
            });

            // Handle generate button
            document.getElementById('generate-report').addEventListener('click', async () => {
                const timeRange = document.getElementById('time-range').value;
                await promptForAIGeneration(timeRange);
            });
        });

        async function loadReportSelector() {
            const reportSelector = document.getElementById('report-selector');
            const reportContent = document.getElementById('report-content');
            
            try {
                const response = await fetch('reports/index.json');
                if (!response.ok) throw new Error('No saved reports found');
                
                const index = await response.json();
                
                if (!index.reports || index.reports.length === 0) {
                    reportSelector.innerHTML = '<option value="">No reports available</option>';
                    showWelcomeMessage();
                    return;
                }
                
                // Clear loading message
                reportSelector.innerHTML = '';
                
                // Populate dropdown with reports (most recent first)
                index.reports.forEach((report, idx) => {
                    const option = document.createElement('option');
                    option.value = `reports/${report.filename}`;
                    
                    // Format display text: date + title
                    const dateStr = report.generatedDate || report.date || 'Unknown date';
                    const titleStr = report.title || report.filename;
                    option.textContent = `${dateStr} - ${titleStr}`;
                    
                    // Select the first (most recent) by default
                    if (idx === 0) {
                        option.selected = true;
                    }
                    
                    reportSelector.appendChild(option);
                });
                
                // Load the most recent report
                if (index.reports.length > 0) {
                    const latestPath = `reports/${index.reports[0].filename}`;
                    await loadSelectedReport(latestPath);
                }
                
            } catch (error) {
                console.error('Error loading reports:', error);
                reportSelector.innerHTML = '<option value="">No reports available</option>';
                showWelcomeMessage();
            }
        }

        async function loadSelectedReport(reportPath) {
            const reportContent = document.getElementById('report-content');
            
            try {
                const response = await fetch(reportPath);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
                const reportData = await response.json();
                
                // Update metadata in header
                if (reportData.metadata) {
                    const period = reportData.metadata.period;
                    if (period && typeof period === 'object') {
                        document.getElementById('report-period').textContent = 
                            `${period.startDate} to ${period.endDate} (${period.weeks} weeks, Blocks ${period.blockRange})`;
                    } else if (typeof period === 'string') {
                        document.getElementById('report-period').textContent = period;
                    }
                    
                    document.getElementById('report-date').textContent = reportData.metadata.generatedDate || '-';
                }
                
                // Extract sessions/blocks from summary.kpis
                if (reportData.summary && reportData.summary.kpis) {
                    const totalSessionsKpi = reportData.summary.kpis.find(k => k.label === 'Total Sessions');
                    const blocksKpi = reportData.summary.kpis.find(k => k.label === 'Blocks Completed');
                    
                    if (totalSessionsKpi) {
                        document.getElementById('total-sessions').textContent = totalSessionsKpi.value;
                    }
                    if (blocksKpi) {
                        document.getElementById('blocks-completed').textContent = blocksKpi.value;
                    }
                }
                
                // Render the report using ProgressReportRenderer
                reportContent.innerHTML = '';
                window.ExercAIse.ProgressReportRenderer.renderReport(reportData, reportContent);
                
            } catch (error) {
                console.error('Error loading report:', error);
                reportContent.innerHTML = `
                    <div class="report-validation-errors">
                        <h2>Error Loading Report</h2>
                        <p>${error.message}</p>
                        <p><em>Note: Legacy HTML reports are no longer supported. Please use JSON format.</em></p>
                    </div>
                `;
            }
        }

        async function loadMostRecentReport() {
            // This function is now replaced by loadReportSelector()
            // Keeping for backward compatibility but not called anymore
            const reportContent = document.getElementById('report-content');
            
            try {
                // Try to load the most recent saved report
                const response = await fetch('reports/index.json');
                if (!response.ok) throw new Error('No saved reports found');
                
                const index = await response.json();
                if (index.reports && index.reports.length > 0) {
                    const latest = index.reports[0]; // Assumes sorted by date descending
                    const reportPath = `reports/${latest.filename}`;
                    await displaySavedReport(reportPath, latest);
                } else {
                    showWelcomeMessage();
                }
            } catch (error) {
                showWelcomeMessage();
            }
        }

        function showWelcomeMessage() {
            const reportContent = document.getElementById('report-content');
            reportContent.innerHTML = `
                <div class="report-section report-section--text">
                    <h2>Welcome to Progress Reports</h2>
                    <div class="report-section__content">
                        <p>Progress reports are AI-generated analyses of your training performance.</p>
                        
                        <h3>How it works:</h3>
                        <ol>
                            <li>Select a time range from the dropdown above</li>
                            <li>Click "Generate Report"</li>
                            <li>Use Kai (AI coach) in chat to analyze your performance logs</li>
                            <li>Kai will generate a comprehensive report and save it to <code>reports/</code></li>
                            <li>Reports are saved for offline viewing</li>
                        </ol>
                        
                        <h3>What Kai analyzes:</h3>
                        <ul>
                            <li><strong>Strength progression</strong> by movement pattern (squat, press, pull, etc.)</li>
                            <li><strong>Endurance improvements</strong> (distance, pace, time)</li>
                            <li><strong>Volume trends</strong> and progressive overload</li>
                            <li><strong>RPE patterns</strong> and recovery indicators</li>
                            <li><strong>Injury/pain notes</strong> and adaptations made</li>
                            <li><strong>Key achievements</strong> and areas for improvement</li>
                        </ul>
                        
                        <p><strong>Ready to get started?</strong> Select a time range above and click "Generate Report".</p>
                    </div>
                </div>
            `;
        }

        async function promptForAIGeneration(timeRange) {
            const reportContent = document.getElementById('report-content');
            
            // Get date range
            const { startDate, endDate } = getDateRange(timeRange);
            
            // Show instructions
            reportContent.innerHTML = `
                <div class="report-section report-section--text">
                    <h2>ðŸ¤– Generate AI Progress Report</h2>
                    <div class="report-section__content">
                        <p>To generate a progress report for <strong>${formatDateRange(startDate, endDate)}</strong>:</p>
                        
                        <h3>Option 1: Use Chat (Recommended)</h3>
                        <ol>
                            <li>Open GitHub Copilot Chat (or your AI assistant)</li>
                            <li>Use the following prompt:</li>
                        </ol>
                    </div>
                    <div style="position: relative;">
                        <pre id="prompt-text" style="background: var(--color-bg-light); padding: var(--space-4); border-radius: var(--radius-sm, 4px); overflow-x: auto; margin: var(--space-4) 0;"><code>Generate a training progress report for the period ${startDate} to ${endDate}.

Follow the prompt in .github/prompts/generate-training-progress-report.prompt.md

Read all performance logs in performed/ within this date range and analyze:
- Strength progression by movement pattern
- Endurance improvements
- Volume trends
- RPE patterns and recovery
- Key achievements and areas for improvement

Output as JSON following schemas/progress-report.schema.json
Save the report as: reports/${formatReportFilename(startDate, endDate)}</code></pre>
                        <button id="copy-prompt-btn" style="position: absolute; top: var(--space-2); right: var(--space-2); background: var(--color-primary); color: white; border: none; padding: var(--space-2); border-radius: var(--radius-sm, 4px); cursor: pointer; font-size: 1.2em; line-height: 1; width: 32px; height: 32px;" title="Copy prompt to clipboard">
                            ðŸ“‹
                        </button>
                    </div>
                    
                    <div class="report-section__content">
                        <h3>Option 2: Use Serverless Function (Coming Soon)</h3>
                        <p>A dedicated API endpoint will be available to generate reports automatically.</p>
                        
                        <h3>After Generation</h3>
                        <p>Once Kai saves the report to <code>reports/</code>, refresh this page to view it.</p>
                    </div>
                </div>
            `;
            
            // Attach event listener to the copy button after it's created
            setTimeout(() => {
                const copyBtn = document.getElementById('copy-prompt-btn');
                if (copyBtn) {
                    copyBtn.addEventListener('click', copyPromptToClipboard);
                }
            }, 0);
        }

        function getDateRange(timeRange) {
            const now = new Date();
            let startDate, endDate;
            
            switch (timeRange) {
                case 'last-4-weeks':
                    startDate = new Date(now.getTime() - 28 * 24 * 60 * 60 * 1000);
                    endDate = now;
                    break;
                case 'last-8-weeks':
                    startDate = new Date(now.getTime() - 56 * 24 * 60 * 60 * 1000);
                    endDate = now;
                    break;
                case 'block-4':
                    startDate = new Date('2025-10-06');
                    endDate = new Date('2025-10-31');
                    break;
                case 'block-3':
                    startDate = new Date('2025-09-08');
                    endDate = new Date('2025-10-05');
                    break;
                case 'block-2':
                    startDate = new Date('2025-08-22');
                    endDate = new Date('2025-09-07');
                    break;
                case 'custom':
                    const startInput = document.getElementById('start-date').value;
                    const endInput = document.getElementById('end-date').value;
                    startDate = startInput ? new Date(startInput) : new Date(0);
                    endDate = endInput ? new Date(endInput) : now;
                    break;
                case 'all':
                default:
                    startDate = new Date('2025-08-22'); // First logged session
                    endDate = now;
                    break;
            }
            
            return {
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0]
            };
        }

        function formatDateRange(start, end) {
            return `${new Date(start).toLocaleDateString()} â†’ ${new Date(end).toLocaleDateString()}`;
        }

        function formatReportFilename(start, end) {
            const startBlock = getBlockFromDate(start);
            const endBlock = getBlockFromDate(end);
            return `${new Date().toISOString().split('T')[0]}_blocks-${startBlock}-${endBlock}.json`;
        }

        function getBlockFromDate(dateStr) {
            const date = new Date(dateStr);
            if (date >= new Date('2025-10-06')) return 4;
            if (date >= new Date('2025-09-08')) return 3;
            if (date >= new Date('2025-08-22')) return 2;
            return 1;
        }

        async function copyPromptToClipboard() {
            const promptElement = document.getElementById('prompt-text');
            const promptText = promptElement.textContent;
            
            try {
                await navigator.clipboard.writeText(promptText);
                
                // Show confirmation
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'âœ…';
                button.style.background = 'var(--color-success)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'var(--color-primary)';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
                alert('Failed to copy to clipboard. Please copy manually.');
            }
        }
    </script>
</body>
</html>
