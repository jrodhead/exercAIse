# AI Coding Agent Instructions for exercAIse

## Critical: Read Architecture First
**Before making any code changes**, read `ARCHITECTURE.md` in the repository root to understand:
- The separation between AI decision-making and app execution
- Why workout logic belongs in `.github/instructions/` and `.github/prompts/`, not in app code
- The data flow from AI generation → display → logging → history → next generation
- Common pitfalls to avoid (e.g., adding workout logic to server or client code)

## Project Overview
- **exercAIse** is a JSON-first fitness program generator, focused on structured, coach-style workout plans for a 40-year-old male with recurring joint issues.
- Workouts are stored as structured JSON (`schemas/session.schema.json`)
- The project is organized around one main AI persona:
  - **Kai** (Strength, Movement & Recovery Coach): workout generation, periodization, injury adaptation, and SessionPlan JSON formatting. See `.github/instructions/kai.instructions.md`.

## Core Architectural Principle
**AI Decides, App Executes**
- ✅ All training logic (progression, exercise selection, ladder snapping, RPE targets) lives in AI instructions and prompts
- ✅ The app (client and server) only displays, collects, and exports data
- ❌ Never add workout decision logic to `assets/app.js` or `serverless/api/kai/session-plan.js`
- ❌ Never calculate progressions, select weights, or modify AI prescriptions in app code

See `ARCHITECTURE.md` for detailed explanation and examples.

## Directory & File Structure
- **workouts/**: All workout sessions as JSON files following `schemas/session.schema.json` (SessionPlan format)
  - Named as `<blockNumber>-<weekNumber>_<Title>.json` (e.g., `4-2_Lower_Body_Strength_Mobility.json`)
  - Each JSON contains: metadata (title, date, block, week), warmup, main sets, cooldown
  - **workouts/manifest.txt**: Auto-generated list of all workout JSON files (one per line, lexicographically sorted)
- **exercises/**: Exercise definitions as JSON files following `schemas/exercise.schema.json`
  - Named as `<exercise_slug>.json` (e.g., `goblet_squat.json`)
  - Contains: name, equipment, tags, setup, steps, cues, mistakes, safety, scaling, variations, prescriptionHints, joints, media
- **performed/**: User performance logs in perf-1 JSON format (auto-generated by app)
  - **performed/index.json**: Manifest of all performance logs with metadata
- **schemas/**: JSON schemas defining data contracts
  - `session.schema.json` (SessionPlan format)
  - `exercise.schema.json` (Exercise definition format)
  - `performed.schema.json` (Performance log format)
- **.github/instructions/**: Persona-specific rules for Kai and Mina. Always consult these before generating workouts or meals
- **.github/prompts/**: AI generation prompts and templates
- **README.md**: Project documentation

## Key Conventions & Patterns
- **JSON-First Architecture**: All workouts are structured JSON (SessionPlan format) validated against `schemas/session.schema.json`
- **SessionPlan Structure**: Each workout JSON includes:
  - **metadata**: `{ title, date, block, week, tags[] }`
  - **warmup**: Array of warm-up items with `{ name, logType, ...fields }`
  - **main**: Array of main work items (strength, carry, endurance, etc.)
  - **cooldown**: Array of cooldown items
  - **logType field**: Determines UI rendering and data collection (`strength`, `carry`, `time`, `distance`, `rpe`, `list`)
- **Exercise References**: Items can include `link` field pointing to `exercises/<slug>.json` for detailed exercise info
- **Performance Tracking**: App collects data in perf-1 format, exports to `performed/`, which informs future AI decisions
- **Naming Conventions**: 
  - Workouts: `<block>-<week>_<Title>.json` (no dates in filenames)
  - Exercises: `<exercise_slug>.json` (lowercase, underscores)
- **Weekly Plan**: Follows block periodization model (see Kai's instructions for details)
- **Recovery/Rest**: Yoga and mobility flows are JSON workouts with `logType: "list"` or `logType: "rpe"`
- **Manifest System**: `workouts/manifest.txt` auto-generated by git hooks, lists all workouts for UI loading

## Developer Workflows
- **Adding a Workout**: 
  1. Create `workouts/<block>-<week>_<Title>.json` following `schemas/session.schema.json`
  2. Validate with `python3 scripts/validate_schemas.py`
  3. Run `python3 scripts/update_manifest.py` to update `workouts/manifest.txt` (or let git hooks do it automatically)
- **Editing a Workout**: Always check `.github/instructions/kai.instructions.md` for structure and adaptation rules
- **Adding/Editing Exercises**:
  1. Create/edit `exercises/<slug>.json` following `schemas/exercise.schema.json`
  2. Validate with `python3 scripts/validate_schemas.py`
- **Adding/Editing Meals**: Follow Mina's guidelines (meals remain markdown-based)
- **Testing**: Run `npx playwright test` for UI tests, `python3 scripts/validate_schemas.py` for data validation
- **CI/CD**: GitHub Actions auto-update manifests and validate all changes on push

## Integration & Extensibility
- **Schema Validation**: All JSON data must validate against schemas in `schemas/`
- **AI Persona Guidance**: All AI agents must read and apply the relevant persona instructions before generating or editing content
- **Chat Modes**: Use `.github/chatmodes/kai.chatmode.md` to run in Kai mode (workouts/recovery). Complete workout generation follows:
  - `.github/prompts/generate-workout-session.prompt.md` (includes content generation AND file creation)
  - `.github/prompts/apply-dumbbell-ladder.prompt.md` (optional: optimize dumbbell loads for minimal plate changes)
- **Manifest System**: `workouts/manifest.txt` and `performed/index.json` are auto-generated by git hooks and app
- **Cross-File Consistency**: Validate with `python3 scripts/validate_links.py` and `python3 scripts/validate_schemas.py`

## Examples
- See `workouts/4-2_Lower_Body_Strength_Mobility.json` for a full strength session in SessionPlan format
- See `workouts/1-3_recovery_Yin_Yoga_Rest_Day.json` for a recovery/yoga flow
- See `exercises/goblet_squat.json` for complete exercise definition following schema v2
- See `.github/instructions/kai.instructions.md` and `.github/instructions/mina.instructions.md` for persona-specific rules

---

## Required Workflow for Workouts and Exercises

### When creating or editing a workout:
- Exercise links in workout Markdown must point directly to the JSON exercise files: use `../../exercises/<slug>.json` when linking from docs inside `.github/`, and `../exercises/<slug>.json` inside `workouts/`. JSON is the source of truth and is rendered by `exercise.html`.
- If an exercise does not already exist in `exercises/`, create a new JSON file `exercises/<slug>.json` as the source of truth, following `schemas/exercise.schema.json` (v2 fields: setup, steps, cues, mistakes, scaling, prescriptionHints, joints, media). Optionally include a minimal `.md` for legacy viewers.
- Never leave an exercise unlinked or without a detail file.
- Update existing workouts if new exercises are introduced to maintain the linking convention.

### New Workout Prompt (for Kai):
Whenever a new workout is requested, always:
- Ask for injury/pain status before generating the workout.
- Confirm the workout progression state, which workout block/week it belongs to, and workout title.
- Generate the workout by following all Kai persona rules in `.github/instructions/kai.instructions.md`.
- For every exercise, ensure the name is a markdown link to its detail page under `exercises/` (e.g., in workouts: `[Goblet Squat](../exercises/goblet_squat.json)`).
- If a new exercise is introduced, create a new JSON detail file `exercises/goblet_squat.json` using the New Exercise JSON Prompt below.
- At the end, confirm that all exercises are linked and all new exercises have detail files.

### New Exercise JSON Prompt (for Kai):
When a new exercise is introduced (not found in `exercises/`):
- Create `exercises/<slug>.json` conforming to `schemas/exercise.schema.json` (v2) with fields:
  - `name` (required), `equipment` (string[]), `tags` (string[])
  - `setup` (string[]): how to position
  - `steps` (string[]): 3–7 ordered execution steps
  - `cues` (string[]): 3–5 short reminders (breath/alignment included)
  - `mistakes` (string[]): 2–4 common faults to avoid
  - `safety` (string): brief injury and pain-adaptation notes
  - `scaling` (regressions[], progressions[]): clear options for easier/harder
  - `variations` (string[]): lateral alternatives
  - `prescriptionHints` (load/reps/time/distance/rpe/notes)
  - `joints` (sensitiveJoints[], notes)
  - `media` (video, images[])
- Optionally add a minimal Markdown file `exercises/<slug>.md` with an H1 header for backwards compatibility; the site prefers JSON.
- Validate with `python3 scripts/validate_schemas.py`.

---

## Architecture & Design Principles

For comprehensive understanding of the system architecture, separation of concerns, and development guidelines, see:
- **`ARCHITECTURE.md`**: Complete system architecture documentation
- **`product-design/notes/`**: Design notes and architectural decisions
- **`.github/instructions/`**: AI persona rules and training logic
- **`.github/prompts/`**: AI generation prompts and guidelines

### Key Reminders
1. **AI makes training decisions, app executes them** - Never add workout logic to app code
2. **Schemas define contracts** - All data must validate against schemas
3. **Backward compatibility matters** - Use optional fields for new features
4. **Exercise JSONs are source of truth** - Always link to `exercises/*.json`, not markdown
5. **History informs AI decisions** - App provides clean data; AI interprets it

