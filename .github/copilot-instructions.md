# AI Coding Agent Instructions for exercAIse

## CRITICAL PRE-FLIGHT CHECKLIST
**Before creating ANY new files or making significant changes**, complete this checklist:

1. ✅ **Read Architecture** - Review `ARCHITECTURE.md` to understand system design and separation of concerns
2. ✅ **Read Style Guide** - Review `style-guide.html` to understand CSS patterns, BEM naming, and design tokens
3. ✅ **Examine Similar Files** - Look at existing pages (e.g., `index.html`, `history.html`, `exercise.html`) to see established patterns
4. ✅ **Read Relevant Instructions** - Check `.github/instructions/` for persona-specific rules if creating workouts/meals
5. ✅ **Validate Schemas** - If working with JSON data, read the relevant schema in `schemas/` first

**NEVER:**
- Create HTML/CSS files without first reading `style-guide.html`
- Add workout logic to app code (read `ARCHITECTURE.md` first)
- Create new JSON files without validating against schemas
- Skip discovery in favor of quick implementation

## Critical: Read Architecture First
**Before making any code changes**, read `ARCHITECTURE.md` in the repository root to understand:
- The separation between AI decision-making and app execution
- Why workout logic belongs in `.github/instructions/` and `.github/prompts/`, not in app code
- The data flow from AI generation → display → logging → history → next generation
- Common pitfalls to avoid (e.g., adding workout logic to server or client code)

## Project Overview
- **exercAIse** is a JSON-first fitness program generator, focused on structured, coach-style workout plans for a 40-year-old male with recurring joint issues.
- Workouts are stored as structured JSON (`schemas/session.schema.json`)
- The project is organized around one main AI persona:
  - **Kai** (Strength, Movement & Recovery Coach): workout generation, periodization, injury adaptation, and SessionPlan JSON formatting. See `.github/instructions/kai.instructions.md`.

## Core Architectural Principle
**AI Decides, App Executes**
- ✅ All training logic (progression, exercise selection, ladder snapping, RPE targets) lives in AI instructions and prompts
- ✅ The app (client and server) only displays, collects, and exports data
- ❌ Never add workout decision logic to `assets/app.js` or `serverless/api/kai/session-plan.js`
- ❌ Never calculate progressions, select weights, or modify AI prescriptions in app code

See `ARCHITECTURE.md` for detailed explanation and examples.

## Directory & File Structure
- **workouts/**: All workout sessions as JSON files following `schemas/session.schema.json` (SessionPlan format)
  - Named as `<blockNumber>-<weekNumber>_<Title>.json` (e.g., `4-2_Lower_Body_Strength_Mobility.json`)
  - Each JSON contains: metadata (title, date, block, week), warmup, main sets, cooldown
  - **workouts/manifest.txt**: Auto-generated list of all workout JSON files (one per line, lexicographically sorted)
- **exercises/**: Exercise definitions as JSON files following `schemas/exercise.schema.json`
  - Named as `<exercise_slug>.json` (e.g., `goblet_squat.json`)
  - Contains: name, equipment, tags, setup, steps, cues, mistakes, safety, scaling, variations, prescriptionHints, joints, media
- **performed/**: User performance logs in perf-2 (nested) or perf-1 (flat) JSON format (auto-generated by app)
  - **performed/index.json**: Manifest of all performance logs with metadata
  - **perf-2 format**: Nested structure preserving workout organization (sections, supersets/circuits with rounds)
  - **perf-1 format**: Legacy flat exercise map
- **reports/**: AI-generated training progress reports
  - **reports/index.json**: Manifest of all progress reports
  - **reports/*.html**: Saved progress reports (AI-generated, displayed by app)
- **schemas/**: JSON schemas defining data contracts
  - `session.schema.json` (SessionPlan format)
  - `exercise.schema.json` (Exercise definition format)
  - `performed-v2.schema.json` (perf-2: nested performance log format)
  - `performance.schema.json` (perf-1: legacy flat format)
- **types/**: TypeScript type definitions
  - `db.types.ts` (IndexedDB schema: performanceLogs, workoutHistory, userSettings, exerciseHistory)
  - `performance.types.ts` (Performance log types)
  - `global.types.ts` (Window API extensions for modules)
- **lib/**: Core libraries (TypeScript)
  - `db.ts` (Type-safe IndexedDB wrapper with CRUD operations)
  - `migration.ts` (Auto-migration from localStorage to IndexedDB)
  - `storage.ts` (Unified storage adapter with IndexedDB primary, localStorage fallback)
- **assets/**: Client-side TypeScript modules
  - `app.ts` (Main app: display, logging, export)
  - `session-parser.ts` (JSON/Markdown parsing utilities)
  - `form-builder.ts` (Dynamic form generation)
  - `kai-integration.ts` (AI validation and integration)
  - `storage-adapter.ts` (Storage module wrapper)
  - `exercise.ts` (Exercise detail page)
- **dist/**: Compiled JavaScript output (generated from TypeScript)
- **.github/instructions/**: Persona-specific rules for Kai and Mina. Always consult these before generating workouts or meals
- **.github/prompts/**: AI generation prompts and templates
- **README.md**: Project documentation
- **ARCHITECTURE.md**: System design and development guidelines
- **MODERNIZATION.md**: ES6+, TypeScript, testing, and IndexedDB migration roadmap

## Key Conventions & Patterns
- **JSON-First Architecture**: All workouts are structured JSON (SessionPlan format) validated against `schemas/session.schema.json`
- **SessionPlan Structure**: Each workout JSON includes:
  - **metadata**: `{ title, date, block, week, tags[] }`
  - **warmup**: Array of warm-up items with `{ name, logType, ...fields }`
  - **main**: Array of main work items (strength, carry, endurance, etc.)
  - **cooldown**: Array of cooldown items
  - **logType field**: Determines UI rendering and data collection (`strength`, `carry`, `time`, `distance`, `rpe`, `list`)
- **Exercise References**: Items can include `link` field pointing to `exercises/<slug>.json` for detailed exercise info
- **Performance Tracking**: App collects data in perf-2 format (nested structure) for JSON workouts or perf-1 (flat) for markdown workouts, exports to `performed/`, which informs future AI decisions
  - **perf-2**: Preserves workout structure (sections, supersets/circuits with rounds) for superior fatigue analysis
  - **perf-1**: Legacy flat format for backward compatibility with markdown workouts
- **Naming Conventions**: 
  - Workouts: `<block>-<week>_<Title>.json` (no dates in filenames)
  - Exercises: `<exercise_slug>.json` (lowercase, underscores)
- **Weekly Plan**: Follows block periodization model (see Kai's instructions for details)
- **Recovery/Rest**: Yoga and mobility flows are JSON workouts with `logType: "list"` or `logType: "rpe"`
- **Manifest System**: `workouts/manifest.txt` auto-generated by git hooks, lists all workouts for UI loading

## Developer Workflows

### Before Starting ANY Development Task:
1. **Identify the file type** you'll be creating/modifying (HTML, JSON, TypeScript, etc.)
2. **Read the relevant reference files**:
   - HTML/CSS → Read `style-guide.html` + examine similar pages
   - JSON → Read relevant schema in `schemas/`
   - Workouts → Read `.github/instructions/kai.instructions.md`
   - TypeScript → Check existing modules in `assets/` or `lib/`
3. **Understand the patterns** before writing any code

### Specific Workflows:

- **Adding a Workout**: 
  1. Create `workouts/<block>-<week>_<Title>.json` following `schemas/session.schema.json`
  2. Validate with `python3 scripts/validate_schemas.py`
  3. Run `python3 scripts/update_manifest.py` to update `workouts/manifest.txt` (or let git hooks do it automatically)
- **Editing a Workout**: Always check `.github/instructions/kai.instructions.md` for structure and adaptation rules
- **Adding/Editing Exercises**:
  1. Create/edit `exercises/<slug>.json` following `schemas/exercise.schema.json`
  2. Validate with `python3 scripts/validate_schemas.py`
- **Creating HTML/CSS Pages**:
  1. **FIRST**: Read `style-guide.html` to understand BEM naming, CSS variables, and design tokens
  2. **SECOND**: Examine similar pages (e.g., `index.html`, `history.html`) to see established patterns
  3. **THIRD**: Create page using CSS variables (var(--color-primary)) and BEM naming (.block__element--modifier)
  4. **NEVER**: Use hardcoded colors, inline styles, or non-BEM class names
- **TypeScript Development**:
  1. Edit `.ts` files in `assets/`, `lib/`, or `types/`
  2. Compile with `npm run build` (outputs to `dist/`)
  3. Test with `npm test` (Vitest unit tests) or `npx playwright test` (E2E tests)
- **Data Storage**:
  - App uses IndexedDB (primary) with localStorage fallback via `lib/storage.ts`
  - Performance logs auto-migrate from localStorage on first app load
  - Export format remains perf-1 JSON to `performed/`
- **Testing**: 
  - Unit tests: `npm test` (78 Vitest tests)
  - E2E tests: `npx playwright test` (26 Playwright tests)
  - Validation: `python3 scripts/validate_schemas.py` and `python3 scripts/validate_links.py`
- **CI/CD**: GitHub Actions auto-update manifests, run TypeScript compilation, and validate all changes on push

## Integration & Extensibility
- **Schema Validation**: All JSON data must validate against schemas in `schemas/`
- **AI Persona Guidance**: All AI agents must read and apply the relevant persona instructions before generating or editing content
- **Chat Modes**: Use `.github/chatmodes/kai.chatmode.md` to run in Kai mode (workouts/recovery). Complete workout generation follows:
  - `.github/prompts/generate-workout-session.prompt.md` (includes content generation AND file creation)
  - `.github/prompts/apply-dumbbell-ladder.prompt.md` (optional: optimize dumbbell loads for minimal plate changes)
- **Manifest System**: `workouts/manifest.txt` and `performed/index.json` are auto-generated by git hooks and app
- **Cross-File Consistency**: Validate with `python3 scripts/validate_links.py` and `python3 scripts/validate_schemas.py`

## Examples
- See `workouts/4-2_Lower_Body_Strength_Mobility.json` for a full strength session in SessionPlan format
- See `workouts/1-3_recovery_Yin_Yoga_Rest_Day.json` for a recovery/yoga flow
- See `exercises/goblet_squat.json` for complete exercise definition following schema v2
- See `.github/instructions/kai.instructions.md` and `.github/instructions/mina.instructions.md` for persona-specific rules

---

## Required Workflow for Workouts and Exercises

### When creating or editing a workout:
- Exercise links in workout Markdown must point directly to the JSON exercise files: use `../../exercises/<slug>.json` when linking from docs inside `.github/`, and `../exercises/<slug>.json` inside `workouts/`. JSON is the source of truth and is rendered by `exercise.html`.
- If an exercise does not already exist in `exercises/`, create a new JSON file `exercises/<slug>.json` as the source of truth, following `schemas/exercise.schema.json` (v2 fields: setup, steps, cues, mistakes, scaling, prescriptionHints, joints, media). Optionally include a minimal `.md` for legacy viewers.
- Never leave an exercise unlinked or without a detail file.
- Update existing workouts if new exercises are introduced to maintain the linking convention.

### New Workout Prompt (for Kai):
Whenever a new workout is requested, always:
- Ask for injury/pain status before generating the workout.
- Confirm the workout progression state, which workout block/week it belongs to, and workout title.
- Generate the workout by following all Kai persona rules in `.github/instructions/kai.instructions.md`.
- For every exercise, ensure the name is a markdown link to its detail page under `exercises/` (e.g., in workouts: `[Goblet Squat](../exercises/goblet_squat.json)`).
- If a new exercise is introduced, create a new JSON detail file `exercises/goblet_squat.json` using the New Exercise JSON Prompt below.
- At the end, confirm that all exercises are linked and all new exercises have detail files.

### New Exercise JSON Prompt (for Kai):
When a new exercise is introduced (not found in `exercises/`):
- Create `exercises/<slug>.json` conforming to `schemas/exercise.schema.json` (v2) with fields:
  - `name` (required), `equipment` (string[]), `tags` (string[])
  - `setup` (string[]): how to position
  - `steps` (string[]): 3–7 ordered execution steps
  - `cues` (string[]): 3–5 short reminders (breath/alignment included)
  - `mistakes` (string[]): 2–4 common faults to avoid
  - `safety` (string): brief injury and pain-adaptation notes
  - `scaling` (regressions[], progressions[]): clear options for easier/harder
  - `variations` (string[]): lateral alternatives
  - `prescriptionHints` (load/reps/time/distance/rpe/notes)
  - `joints` (sensitiveJoints[], notes)
  - `media` (video, images[])
- Optionally add a minimal Markdown file `exercises/<slug>.md` with an H1 header for backwards compatibility; the site prefers JSON.
- Validate with `python3 scripts/validate_schemas.py`.

---

## Architecture & Design Principles

For comprehensive understanding of the system architecture, separation of concerns, and development guidelines, see:
- **`ARCHITECTURE.md`**: Complete system architecture documentation
- **`product-design/notes/`**: Design notes and architectural decisions
- **`.github/instructions/`**: AI persona rules and training logic
- **`.github/prompts/`**: AI generation prompts and guidelines

### Key Reminders
1. **AI makes training decisions, app executes them** - Never add workout logic to app code
2. **Schemas define contracts** - All data must validate against schemas
3. **Backward compatibility matters** - Use optional fields for new features
4. **Exercise JSONs are source of truth** - Always link to `exercises/*.json`, not markdown
5. **History informs AI decisions** - App provides clean data; AI interprets it
6. **Performance log format** - Use perf-2 (nested) for JSON workouts, perf-1 (flat) for markdown workouts

---

## AI Guidance: Using Round-Level Performance Data (perf-2)

### Understanding perf-2 Performance Logs

When reviewing performance logs in perf-2 format, you have access to rich structural context:

**Key Data Available**:
- **Sections**: Warm-up, Strength, Conditioning, Accessory/Core, Cooldown/Recovery
- **Items**: Standalone exercises (with `sets[]`) or supersets/circuits (with `rounds[]`)
- **Rounds**: Round-by-round performance for each exercise in supersets/circuits
- **Exercise Index**: Pre-computed summaries (total volume, avg RPE, JSONPath references)

### Analyzing Fatigue Patterns from Round-Level Data

**1. Identify Fatigue Type from Round Progression**:

```typescript
// Example: Superset A - Bench Press + Close-Grip Press
Round 1: Bench 45×2 × 10 @ RPE 7,  Close-Grip 30×2 × 10 @ RPE 7
Round 2: Bench 45×2 × 10 @ RPE 8,  Close-Grip 30×2 × 10 @ RPE 8
Round 3: Bench 45×2 × 6  @ RPE 9,  Close-Grip 30×2 × 6  @ RPE 9

Analysis: "Fatigue cascade from pairing"
- Round 1 RPE 7 (not too heavy initially)
- RPE climbs across rounds (7→8→9)
- Both exercises decline together (triceps is shared muscle)
- This is COMPOUND FATIGUE, not exercise being too heavy
```

**2. Distinguish "Exercise Too Heavy" vs "Fatigue Cascade"**:

| Pattern | Diagnosis | Action |
|---------|-----------|--------|
| Round 1 @ RPE ≥9, immediate rep drop | Exercise too heavy | Reduce load 5-10% |
| RPE 7→8→9 across rounds, reps decline in round 3 | Cumulative fatigue (acceptable) | Progress as planned OR increase rest |
| Secondary exercise fails first (e.g., triceps in bench+CGBP superset) | Synergist fatigue cascade | Separate exercises OR reduce secondary load |
| RPE stays 7-8 across all rounds | Good challenge | Add reps or load next session |

**3. Query Patterns for Analysis**:

```typescript
// Access superset rounds
const strengthSection = log.sections.find(s => s.type === 'Strength');
const supersetA = strengthSection?.items.find(i => 
  i.kind === 'superset' && i.name.includes('Superset A')
);

// Analyze round-by-round progression
supersetA?.rounds.forEach((round, i) => {
  console.log(`Round ${round.round}:`);
  round.exercises.forEach(ex => {
    console.log(`  ${ex.name}: ${ex.weight}×${ex.multiplier} × ${ex.reps} @ RPE ${ex.rpe}`);
  });
});

// Use exerciseIndex for fast lookups
const benchSummary = log.exerciseIndex['flat-dumbbell-bench-press'];
console.log(`Avg RPE: ${benchSummary.avgRPE}, Total Volume: ${benchSummary.totalVolume}`);
```

**4. Prescription Adjustments Based on Round Data**:

**Scenario A: Synergist Fatigue (Triceps giving out)**
```
Observation: Bench press maintained 45×2 × 8-10 across rounds, 
             but Close-Grip dropped from 10→10→6 reps
Decision: 
  Option 1: Separate exercises (bench → straight sets, not superset)
  Option 2: Use antagonist pairing (bench + rows instead of bench + triceps)
  Option 3: Reduce close-grip load (30×2 → 25×2) to match fatigue tolerance
```

**Scenario B: Cumulative Fatigue (Both exercises decline together)**
```
Observation: Both exercises RPE 7→8→9, reps maintained until round 3
Decision:
  - This is GOOD training stimulus (acceptable fatigue)
  - Progress as planned: increase load or reps next week
  - Optional: Add 15-30s rest if RPE 9 is too aggressive
```

**Scenario C: Exercise Too Heavy (Immediate struggle)**
```
Observation: Round 1 @ RPE 9, rep target missed immediately
Decision:
  - Reduce load 5-10% for next session
  - Example: 50×2 → 45×2, aim for RPE 7-8 on round 1
```

**5. Progressive Overload with Round Context**:

```
Week 1 (Baseline):
  Round 1-3: 45×2 × 8, 8, 6 @ RPE 7, 8, 9
  Analysis: Acceptable fatigue pattern

Week 2 (Maintain):
  If all rounds hit RPE ≤8: add 1-2 reps
  Target: 45×2 × 10, 10, 8 @ RPE 7, 8, 8

Week 3 (Progress):
  If top of rep range hit: increase load
  Apply ladder: 45 → 50 (next rung)
  Reduce reps to maintain RPE: 50×2 × 8, 8, 6 @ RPE 7, 8, 8

Week 4 (Deload):
  Reduce load 15-20%, keep structure
  Target: 40×2 × 8, 8, 8 @ RPE 6, 6, 7
```

**6. Structure Modifications**:

Based on round analysis, you may suggest:
- **Increase rest**: 90s → 120s between rounds (if RPE climbs too fast)
- **Reduce rounds**: 4 → 3 rounds (if recovery poor between sessions)
- **Change pairing**: Antagonist muscles (push/pull) instead of synergist (push/push)
- **Separate exercises**: Superset → straight sets (if fatigue cascade too severe)

### Migration Notes

**Block 5 Week 1 Data Loss**:
- 3 sessions logged before perf-2 implementation (Chest/Triceps, Glutes/Core, Back/Biceps)
- Data loss accepted - minimal impact, blocks 1-4 preserved in progress reports
- Can be re-entered manually if critical for analysis

**Current Usage**:
- JSON workouts → perf-2 format (nested structure)
- Markdown workouts → perf-1 format (flat, legacy)
- All new workouts use JSON/perf-2 for rich analysis
4. **Exercise JSONs are source of truth** - Always link to `exercises/*.json`, not markdown
5. **History informs AI decisions** - App provides clean data; AI interprets it

